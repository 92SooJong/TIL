# 6.2 그룹 코디네이터

- 컨슈머들은 하나의 컨슈머 그룹의 구성원으로 속한다.
- 컨슈머 그룹내에서 컨슈머들은 서로 자신의 정보를 공유하면서 하나의 공동체로 동작한다.
- 컨슈머는 컨슈머 그룹을 옮길수 있다.
- 컨슈머 그룹은 변화를 인지하고 작업을 균등하게 분배하는 역할을 한다. (컨슈머 리밸런싱)

# 그룹 코디네이터

- 컨슈머 그룹 관리를 위한 코디네이터
- 컨슈머 그룹이 구독한 토픽의 파티션들과 그룹의 멤버들을 트래킹 하는것이 목적이다.
- 그룹 코디네이터는 각 컨슈머 그룹별로 존재한다.
- 그룹 코디네이터는 카프카 클러스터 내의 브로커 중 하나에 위치한다.

# 컨슈머 그룹 등록 과정

1. 컨슈머는 설정값 중 `bootstrap.brokers` 리스트에 있는 브로커에게 커넥션 연결을 위한 요청을 보낸다.
2. 요청을 받은 브로커는 그룹 코디네이터를 생성한다. (컨슈머 그룹에 첫번째 컨슈머가 등록될때까지 아무 작업도 일어나지 않는다.)
3. 그룹 코디네이터는 `group.initial.rebalance.delay.ms` 의 시간동안 컨슈머의 요청을 기다린다.
4. 컨슈머는 컨슈머 등록 요청을 그룹 코디네이터에게 보낸다. 가장 먼저 요청을 보내는 컨슈머가 컨슈머 그룹의 리더가 된다.
5. 그룹 코디네이터는 리더 컨슈머에게 토픽, 파티션 리스트 등 각종 정보를 보낸다.
6. 리더 컨슈머는 정해진 컨슈머 파티션 할당 전략에 따라 그룹 내 컨슈머들에게 파티션을 할당한다.
7. 리더 컨슈머는 할당한 전략에 대한 정보를 그룹 코디네이터에게 전달한다.
8. 그룹 코디네이터는 해당 정보를 캐시하고 각 그룹 내 컨슈머들에게 성공을 알린다.
9. 각 컨슈머들은 각자 지정된 토픽 파티션으로부터 메시지들을 가져온다.

# 하트비트

- 컨슈머들의 변경을 감지하기 위해 그룹 코디네이터와 컨슈머들은 서로 하트비트를 주고 받는다.
- 하트비트와 관련된 옵션으로는 아래 3가지가 있다.
- `session.timeout.ms` 는 컨슈머가 특정 시간 안에 하트비트를 받지 못하면 해당 컨슈머를 제거하고 리밸런싱 작업을 수행한다. (기본값은 10000)
- `heartbeat.interval.ms` 는 그룹 코디네이터와 하트비트 인터벌 시간이다.  `session.timeout.ms` 보다 낮게 설정해야 하며, 3분의 1 수준이 적당하다. (기본값 3000)
- `max.poll.interval.ms` 시간이 될때까지 컨슈머가 토픽으로부터 polling을 하지 않는다면 컨슈머를 제거하고 리밸런싱 작업을 수행한다. (기본값은 300000 -5분)
- 컨슈머 리밸런싱은 비용이 높기 때문에 가급적 리밸런싱이 자주 발생하지 않도록 해야한다.
- 가능하면 기본 설정을 유지하는게 좋다.