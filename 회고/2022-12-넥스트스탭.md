---
title: "ë„¥ìŠ¤íŠ¸ìŠ¤íƒ­ 2ì£¼ì°¨ ê°•ì˜ ê¸°ë¡"
date: 2022-12-02T22:00:00+09:00
tags: ["í•„ê¸°","Korean"]
---

# ê³µë¶€ê±°ë¦¬
- ë¼ìš°íŒ… í…Œì´ë¸”
- ICMPëŠ” í•‘ì„ ìœ„í•œ í”„ë¡œí† ì½œ(?)
- NAT Gateway
- Internet GateWay
- Bastion
- shell ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²•
- ë¦¬ëˆ…ìŠ¤ Logger
- flyway

# next-step 2ì£¼ì°¨ ê°•ì˜
- USE ë°©ë²•ë¡ 
- ì„œë²„ê°„ í†µì‹ í• ë•ŒëŠ” private ipë¡œ í•˜ê¸°. ê³µì¸ IPë¡œ í•˜ê²Œë˜ë©´ ì¸í„°ë„·ìœ¼ë¡œ ë‚˜ê°”ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì˜¤ê²Œë¨.(ë¹„íš¨ìœ¨ì ì„) ë² ìŠ¤ì²œì—ì„  ì¸í„°ë„·ì´ë¼ê³  ì°©ê°í•˜ê²Œë¨. ë³´ì•ˆê·¸ë£¹ì´ ë³µì¡í•´ì§.
- bastion ì„œë²„ë¥¼ ë‚˜ë‘” ì´ìœ ëŠ” DDOSê°™ì€ ê³µê²©ì´ ë°œìƒí•˜ë”ë¼ë„ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í†µë¡œê°€ ì—¬ì „íˆ í™•ë³´ë˜ì–´ìˆë‹¤.
- ê°€ìš©ì„± : ì‹œìŠ¤í…œì´ ì„œë¹„ìŠ¤ë¥¼ ì •ìƒì ìœ¼ë¡œ ì œê³µí•  ìˆ˜ ìˆëŠ” ìƒíƒœ
- ì„±ëŠ¥ì´ ìš°ìˆ˜í•˜ë‹¤ = Users(ë™ì‹œì ‘ì†ì ìˆ˜) , TPS(ì²˜ë¦¬ì†ë„)), Time(ì‘ë‹µì†ë„))
- Active UserëŠ” ìš”ì²­ì„ ê³„ì†í•´ì„œ ë³´ë‚´ëŠ” ì‚¬ìš©ì, Concurrent user ì‘ë‹µìœ¼ë¡œ ë°›ì€ í˜ì´ì§€ë¥¼ ê³„ì†í•´ì„œ ë³´ëŠ” ì‚¬ìš©ì
- ì²˜ë¦¬ëŸ‰ : ì¼ì •ì‹œê°„ë™ì•ˆ ì–¼ë§ˆë‚˜ ë§ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ”ì§€. Stress Testë¥¼ ìˆ˜í–‰. Scalue out, Scale upìœ¼ë¡œ ëŒ€ì‘í•œë‹¤. ë‹¨ì¼ ì‚¬ìš©ìì— ëŒ€í•œ ì‘ë‹µì†ë„ê°€ ëŠë ¤ì§„ë‹¤ë©´ scale up. ë¶€í•˜ê°€ ë§ì•„ì§ˆ ê²½ìš° ì‘ë‹µì†ë„ê°€ ëŠë ¤ì§„ë‹¤ë©´ scale outì„ ìˆ˜í–‰í•œë‹¤.
- ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì¢…ë¥˜ 
  - smoke. ìµœì†Œí•œì˜ ë¶€í•˜ë¡œ, í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì˜¤ë¥˜ë¥¼ ê²€ì¦. VUser 1 ~ 2ë¡œ êµ¬ì„±.
  - load : í”¼í¬íƒ€ì„ íŠ¸ë˜í”½ì„ ê³„ì†í•´ì„œ ìš”ì²­í•œë‹¤. 
  - stress : ì ì§„ì ìœ¼ë¡œ ë¶€í•˜ê°€ ì¦ê°€ì‹œí‚¨ë‹¤. ë¬¸ì œê°€ ë°œìƒí• ë•Œê¹Œì§€ ë¶€í•˜ë¥¼ ì¦ê°€ ì‹œí‚¨ë‹¤. ì‹¤ì œëŠ” í•œë²ˆì— ìš”ì²­ì´ ë“¤ì–´ì˜¤ëŠ”ë° stressëŠ” ì ì§„ì ìœ¼ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ë‹¤
- ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ
  - k6 : ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤
- ì„±ëŠ¥ ëª©í‘œë¥¼ ìš°ì„  ì •í•´ì•¼ í•œë‹¤!!!
- ì‹¤ì œ ì‚¬ìš©ìê°€ ì ‘ì†í•˜ëŠ” í™˜ê²½
- ë¶€í•˜ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ ë‚´ë¶€ ì²˜ë¦¬ì‹œê°„ì´ ë°°ì œë˜ì–´ ìˆìŒì„ ì—¼ë‘í•´ ë‘ì–´ì•¼í•œë‹¤.



# ë°°í¬ Shell Script ì˜ˆì‹œ
```bash
#!/bin/bash

## ìƒ‰ìƒ ë³€ìˆ˜ ì„¤ì •

txtrst='\033[1;37m' # White
txtred='\033[1;31m' # Red
txtylw='\033[1;33m' # Yellow
txtpur='\033[1;35m' # Purple
txtgrn='\033[1;32m' # Green
txtgra='\033[1;30m' # Gray

echo -e "${txtylw}=======================================${txtrst}"
echo -e "${txtgrn}  << ìŠ¤í¬ë¦½íŠ¸ ğŸ§ >>${txtrst}"
echo -e "${txtylw}=======================================${txtrst}"

## ë³€ìˆ˜ ì„¤ì •
PROJECT_PATH=/home/ubuntu/nextstep/infra-subway-deploy

## í”„ë¡œì íŠ¸ ê²½ë¡œë¡œ ì´ë™
function changeDirectoryToProject() {
  echo -e "${txtgrn}>> Move to Project Directory${txtrst}"
  cd $PROJECT_PATH

}


## ì €ì¥ì†Œ pull
function pull() {
  echo -e ""
  echo -e "${txtgrn}>> PULL main BRANCH ${txtrst}"
  git pull origin main
}

## gradle build
function build() {
  echo -e ""
  echo -e "${txtgrn}>> BUILD${txtrst}"
  ./gradlew clean build
}


## í”„ë¡œì„¸ë¥¼ KILL í•˜ëŠ” ëª…ë ¹ì–´
function killProcess() {
  echo -e ""
  echo -e "${txtgrn}>> KILL PROCESS${txtrst}"
  PID=$(lsof -ti tcp:8080)
  if [ -z "${PID}" ]
    then
      echo "> NO RUNNING PROCESS IN PORT 8080"  
    else
      echo -e "KILL ${PID}"
      kill -9 "${PID}"
  fi
}

## ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰
function run() {
  echo -e ""
  echo -e "${txtgrn}>> RUN APPLICATION ${txtrst}"

  JAR_PATH=$(find $PROJECT_PATH/build/libs/*jar)
  JAR_NAME=$(basename "$JAR_PATH")
  echo -e "Jar name is ${JAR_NAME}"

  nohup java -jar -Dspring.profiles.active=prod ./${JAR_NAME} 1> ./subway.log 2>&1  &
}

changeDirectoryToProject;
pull;
build;
killProcess;
run;

```

@brainbackdoor 
ì•ˆë…•í•˜ì„¸ìš”. ë™ê·œë‹˜.

nginx.conf íŒŒì¼ì„ ìˆ˜ì •í•˜ê³  image Buildë¥¼ í–ˆì—ˆì–´ì•¼ í–ˆëŠ”ë° ê·¸ëƒ¥ ê¸°ì¡´ì˜ imageë¡œ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í–ˆì—ˆìŠµë‹ˆë‹¤. ã… ã… 

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì—ì„œ í•œê°€ì§€ ì§ˆë¬¸ ì‚¬í•­ìˆìŠµë‹ˆë‹¤. 

### Q. ì•„ë˜ ì‘ì„±í•œ nginx.confì˜ 172.17.0.1:8080ì€ ì–´ë–¤ ì„œë²„ì¸ê°€ìš”?? 
```
upstream app {
    server 172.17.0.1:8080;
  }
```

listen 443ì„ ì²˜ë¦¬í•˜ëŠ” serverì˜ proxy_passë¥¼ ë³´ë©´ appì˜ serverê°€ 172.17.0.1:8080ì´ ì•„ë‹Œ localhost:8080ê°€ ë˜ì–´ì•¼ í•˜ëŠ”ê²ƒ ì²˜ëŸ¼  ë³´ì´ëŠ”ë° í˜¹ì‹œ ì¤‘ê°„ì— ì œê°€ ë†“ì¹˜ê³  ìˆëŠ” ì„œë²„ê°€ ìˆëŠ”ì§€ ê¶ê¸ˆí•©ë‹ˆë‹¤. 
(localhost:8080ì´ë¼ ìƒê°í•œ ì´ìœ ëŠ”? reverse proxyê°€ 443 í¬íŠ¸ë¡œ ì˜¤ëŠ” requestë¥¼ ë°›ì•„ì„œ ì‹¤ì œë¡œ êµ¬ë™ì¤‘ì¸ ì„œë²„ë¡œ forwarding í•´ì•¼í•˜ë¯€ë¡œ )

```
server {
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/92soojong.p-e.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/92soojong.p-e.kr/privkey.pem;

    # Disable SSL
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

    # í†µì‹ ê³¼ì •ì—ì„œ ì‚¬ìš©í•  ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

    # Enable HSTS
    # clientì˜ browserì—ê²Œ httpë¡œ ì–´ë– í•œ ê²ƒë„ load í•˜ì§€ ë§ë¼ê³  ê·œì œí•©ë‹ˆë‹¤.
    # ì´ë¥¼ í†µí•´ httpì—ì„œ httpsë¡œ redirect ë˜ëŠ” requestë¥¼ minimize í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    add_header Strict-Transport-Security "max-age=31536000" always;

    # SSL sessions
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location / {
      proxy_pass http://app;
    }
  }
```

docker run -it --rm --name certbot \
  -v '/etc/letsencrypt:/etc/letsencrypt' \
  -v '/var/lib/letsencrypt:/var/lib/letsencrypt' \
  certbot/certbot certonly -d '92soojong.o-r.kr' --manual --preferred-challenges dns --server https://acme-v02.api.letsencrypt.org/directory


_acme-challenge.92soojong.o-r.kr
ckl5NpVO6Uqr-1ckGKKG_VHMa1R1-aeubGEzWl6VOVM

cp /etc/letsencrypt/live/92soojong.o-r.kr/fullchain.pem ./
cp /etc/letsencrypt/live/92soojong.o-r.kr/privkey.pem ./





